--- buggy+++ fixed@@ -4959,11 +4959,14 @@     if (const auto *ExactOp = dyn_cast<PossiblyExactOperator>(Op))
       if (ExactOp->isExact())
         return true;
-    if (const auto *FP = dyn_cast<FPMathOperator>(Op)) {
-      auto FMF = FP->getFastMathFlags();
-      if (FMF.noNaNs() || FMF.noInfs())
-        return true;
-    }
+  }
+
+  // TODO: this should really be under the ConsiderFlags block, but currently
+  // these are not dropped by dropPoisonGeneratingFlags
+  if (const auto *FP = dyn_cast<FPMathOperator>(Op)) {
+    auto FMF = FP->getFastMathFlags();
+    if (FMF.noNaNs() || FMF.noInfs())
+      return true;
   }
 
   unsigned Opcode = Op->getOpcode();
