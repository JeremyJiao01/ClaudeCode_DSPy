--- buggy+++ fixed@@ -565,8 +565,11 @@ 
 #ifndef NDEBUG
   if (status == opt::Pass::Status::SuccessWithoutChange) {
-    auto changed = optimized_binary->size() != original_binary_size ||
-                   memcmp(optimized_binary->data(), original_binary,
+    std::vector<uint32_t> optimized_binary_with_nop;
+    context->module()->ToBinary(&optimized_binary_with_nop,
+                                /* skip_nop = */ false);
+    auto changed = optimized_binary_with_nop.size() != original_binary_size ||
+                   memcmp(optimized_binary_with_nop.data(), original_binary,
                           original_binary_size) != 0;
     assert(!changed &&
            "Binary unexpectedly changed despite optimizer saying there was no "
