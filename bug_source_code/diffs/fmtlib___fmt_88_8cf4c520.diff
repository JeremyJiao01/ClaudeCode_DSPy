--- buggy+++ fixed@@ -1292,9 +1292,12 @@     for (auto end = p + s.size() - block_size + 1; p < end;) p = transcode(p);
   }
   if (auto num_chars_left = s.data() + s.size() - p) {
-    char buf[4] = {};
+    char buf[2 * block_size - 1] = {};
     memcpy(buf, p, num_chars_left);
-    transcode(buf);
+    p = buf;
+    do {
+      p = transcode(p);
+    } while (p - buf < num_chars_left);
   }
   buffer_.push_back(0);
 }
